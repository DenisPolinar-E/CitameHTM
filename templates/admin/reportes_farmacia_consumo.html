{% extends 'dashboard/base_dashboard.html' %}
{% block content %}
<div class="container py-4">
    <h2 class="mb-4"><i class="fa fa-pills me-2"></i>Consumo de Medicamentos</h2>
    <div class="row mb-3 align-items-end">
        <div class="col-md-2">
            <label for="tipo_ranking" class="form-label">Tipo de ranking:</label>
            <select id="tipo_ranking" class="form-select">
                <option value="mas_consumidos">Top 10 Más Consumidos</option>
                <option value="menos_consumidos">Top 10 Menos Consumidos</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="filtro" class="form-label">Filtrar por:</label>
            <select id="filtro" class="form-select">
                <option value="mes">Mes</option>
                <option value="trimestre">Trimestre</option>
                <option value="anio">Año</option>
            </select>
        </div>
        <div class="col-md-2" id="filtro_mes">
            <label for="periodo_mes" class="form-label">Mes:</label>
            <input type="month" id="periodo_mes" class="form-control" value="{{ now|date:'Y-m' }}">
        </div>
        <div class="col-md-3 d-none" id="filtro_trimestre">
            <label for="periodo_trimestre" class="form-label">Trimestre:</label>
            <select id="periodo_trimestre" class="form-select">
                <option value="1">Enero - Marzo</option>
                <option value="2">Abril - Junio</option>
                <option value="3">Julio - Septiembre</option>
                <option value="4">Octubre - Diciembre</option>
            </select>
            <label for="anio_trimestre" class="form-label mt-2">Año:</label>
            <input type="number" id="anio_trimestre" class="form-control" min="2000" max="2100" value="{{ now|date:'Y' }}">
        </div>
        <div class="col-md-2 d-none" id="filtro_anio">
            <label for="periodo_anio" class="form-label">Año:</label>
            <input type="number" id="periodo_anio" class="form-control" min="2000" max="2100" value="{{ now|date:'Y' }}">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button id="btnBuscar" class="btn btn-primary w-100" type="button">
                <i class="fa fa-search me-1"></i> Buscar
            </button>
        </div>
    </div>
    <div class="card shadow-sm">
        <div class="card-body position-relative">
            <div id="spinnerCarga" class="position-absolute top-50 start-50 translate-middle" style="display:none;z-index:2;">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
            <canvas id="grafico_consumo" height="100"></canvas>
            <div id="mensajeSinDatos" class="text-center text-muted mt-4" style="display:none;">
                <i class="fa fa-info-circle fa-2x mb-2"></i><br>
                No hay datos para mostrar en el periodo seleccionado.
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="/static/js/chart.js"></script>
<script>
function obtenerPeriodo() {
    const filtro = $('#filtro').val();
    const tipoRanking = $('#tipo_ranking').val();
    let params = {tipo_ranking: tipoRanking};
    
    if (filtro === 'mes') {
        params.filtro = 'mes';
        params.periodo = $('#periodo_mes').val();
    } else if (filtro === 'trimestre') {
        params.filtro = 'trimestre';
        params.periodo = $('#anio_trimestre').val() + '-' + $('#periodo_trimestre').val();
    } else if (filtro === 'anio') {
        params.filtro = 'anio';
        params.periodo = $('#periodo_anio').val();
    }
    
    return params;
}
function mostrarSpinner(mostrar) {
    $('#spinnerCarga').toggle(mostrar);
}
function cargarGrafico() {
    mostrarSpinner(true);
    $('#mensajeSinDatos').hide();
    const params = obtenerPeriodo();
    $.getJSON(window.location.pathname, params, function(resp) {
        mostrarSpinner(false);
        if(window.graficoConsumo) window.graficoConsumo.destroy();
        if(!resp.labels || resp.labels.length === 0) {
            $('#mensajeSinDatos').show();
            return;
        }
        const tipoRanking = $('#tipo_ranking').val();
        const tituloGrafico = tipoRanking === 'mas_consumidos' ? 
            'Top 10 medicamentos más consumidos' : 
            'Top 10 medicamentos menos consumidos';
        
        window.graficoConsumo = new Chart(document.getElementById('grafico_consumo'), {
            type: 'bar',
            data: {
                labels: resp.labels,
                datasets: [{
                    label: 'Cantidad consumida',
                    data: resp.data,
                    backgroundColor: tipoRanking === 'mas_consumidos' ? 
                        'rgba(54, 162, 235, 0.7)' : 'rgba(255, 99, 132, 0.7)',
                    borderColor: tipoRanking === 'mas_consumidos' ? 
                        'rgba(54, 162, 235, 1)' : 'rgba(255, 99, 132, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: tituloGrafico
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Medicamento' } },
                    y: { title: { display: true, text: 'Cantidad' }, beginAtZero: true }
                }
            }
        });
    }).fail(function() {
        mostrarSpinner(false);
        $('#mensajeSinDatos').show().text('Error al cargar los datos.');
    });
}
$(function() {
    $('#filtro').change(function() {
        $('#filtro_mes, #filtro_trimestre, #filtro_anio').addClass('d-none');
        if(this.value === 'mes') $('#filtro_mes').removeClass('d-none');
        if(this.value === 'trimestre') $('#filtro_trimestre').removeClass('d-none');
        if(this.value === 'anio') $('#filtro_anio').removeClass('d-none');
    });
    
    // Evento para cambiar tipo de ranking
    $('#tipo_ranking').change(cargarGrafico);
    
    $('#btnBuscar').click(cargarGrafico);
    $('#periodo_mes, #periodo_trimestre, #anio_trimestre, #periodo_anio').on('keydown', function(e) {
        if(e.key === 'Enter') cargarGrafico();
    });
    cargarGrafico();
});
</script>
{% endblock %} 