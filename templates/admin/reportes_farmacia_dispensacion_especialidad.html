{% extends 'dashboard/base_dashboard.html' %}
{% block content %}
<div class="container py-4">
    <h2 class="mb-4"><i class="fa fa-notes-medical me-2 text-info"></i>Dispensación por Especialidad</h2>
    <div class="row mb-3 align-items-end">
        <div class="col-md-3">
            <label for="filtro" class="form-label">Filtrar por:</label>
            <select id="filtro" class="form-select">
                <option value="mes">Mes</option>
                <option value="trimestre">Trimestre</option>
                <option value="anio">Año</option>
            </select>
        </div>
        <div class="col-md-3" id="filtro_mes">
            <label for="periodo_mes" class="form-label">Mes:</label>
            <input type="month" id="periodo_mes" class="form-control" value="{{ now|date:'Y-m' }}">
        </div>
        <div class="col-md-3 d-none" id="filtro_trimestre">
            <label for="periodo_trimestre" class="form-label">Trimestre:</label>
            <select id="periodo_trimestre" class="form-select">
                <option value="1">Enero - Marzo</option>
                <option value="2">Abril - Junio</option>
                <option value="3">Julio - Septiembre</option>
                <option value="4">Octubre - Diciembre</option>
            </select>
            <label for="anio_trimestre" class="form-label mt-2">Año:</label>
            <input type="number" id="anio_trimestre" class="form-control" min="2000" max="2100" value="{{ now|date:'Y' }}">
        </div>
        <div class="col-md-3 d-none" id="filtro_anio">
            <label for="periodo_anio" class="form-label">Año:</label>
            <input type="number" id="periodo_anio" class="form-control" min="2000" max="2100" value="{{ now|date:'Y' }}">
        </div>
        <div class="col-md-2 d-flex align-items-end">
            <button id="btnBuscar" class="btn btn-primary w-100" type="button">
                <i class="fa fa-search me-1"></i> Buscar
            </button>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white"><i class="fa fa-chart-pie me-2"></i>Gráfica de Pastel</div>
                <div class="card-body">
                    <canvas id="grafico_pastel" height="180"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white"><i class="fa fa-chart-bar me-2"></i>Gráfica de Barras</div>
                <div class="card-body">
                    <canvas id="grafico_barras" height="180"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light"><i class="fa fa-table me-2"></i>Tabla de Dispensación por Especialidad</div>
        <div class="card-body p-2">
            <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Especialidad</th>
                            <th>Cantidad de Medicamentos Dispensados</th>
                        </tr>
                    </thead>
                    <tbody id="tabla_dispensacion">
                        <tr><td colspan="2" class="text-center text-muted">Cargando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="/static/js/chart.js"></script>
<script>
function obtenerPeriodo() {
    const filtro = $('#filtro').val();
    if (filtro === 'mes') {
        return {filtro: 'mes', periodo: $('#periodo_mes').val()};
    } else if (filtro === 'trimestre') {
        return {filtro: 'trimestre', periodo: $('#anio_trimestre').val() + '-' + $('#periodo_trimestre').val()};
    } else if (filtro === 'anio') {
        return {filtro: 'anio', periodo: $('#periodo_anio').val()};
    }
}
function cargarReporte() {
    const params = obtenerPeriodo();
    $.getJSON(window.location.pathname, params, function(resp) {
        // Tabla
        let filas = '';
        if(resp.tabla.length === 0) {
            filas = '<tr><td colspan="2" class="text-center text-success">No hay datos para mostrar.</td></tr>';
        } else {
            resp.tabla.forEach(function(e) {
                filas += `<tr><td>${e.receta__medico__especialidad__nombre || 'Sin especialidad'}</td><td>${e.total}</td></tr>`;
            });
        }
        $('#tabla_dispensacion').html(filas);
        // Gráfica de pastel
        if(window.graficoPastel) window.graficoPastel.destroy();
        window.graficoPastel = new Chart(document.getElementById('grafico_pastel'), {
            type: 'pie',
            data: {
                labels: resp.labels,
                datasets: [{
                    label: 'Dispensación',
                    data: resp.data,
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)',
                        'rgba(99, 255, 132, 0.7)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: {
                        display: true,
                        text: 'Dispensación de medicamentos por especialidad'
                    }
                }
            }
        });
        // Gráfica de barras
        if(window.graficoBarras) window.graficoBarras.destroy();
        window.graficoBarras = new Chart(document.getElementById('grafico_barras'), {
            type: 'bar',
            data: {
                labels: resp.labels,
                datasets: [{
                    label: 'Cantidad dispensada',
                    data: resp.data,
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Dispensación de medicamentos por especialidad'
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Especialidad' } },
                    y: { title: { display: true, text: 'Cantidad' }, beginAtZero: true }
                }
            }
        });
    });
}
$(function() {
    $('#filtro').change(function() {
        $('#filtro_mes, #filtro_trimestre, #filtro_anio').addClass('d-none');
        if(this.value === 'mes') $('#filtro_mes').removeClass('d-none');
        if(this.value === 'trimestre') $('#filtro_trimestre').removeClass('d-none');
        if(this.value === 'anio') $('#filtro_anio').removeClass('d-none');
    });
    $('#btnBuscar').click(cargarReporte);
    $('#periodo_mes, #periodo_trimestre, #anio_trimestre, #periodo_anio').on('keydown', function(e) {
        if(e.key === 'Enter') cargarReporte();
    });
    cargarReporte();
});
</script>
{% endblock %} 