{% extends 'dashboard/base_dashboard.html' %}
{% block content %}
<div class="container py-4">
    <h2 class="mb-4"><i class="fa fa-triangle-exclamation me-2 text-warning"></i>Stock Crítico y Alertas</h2>
    <div class="d-flex justify-content-end mb-3">
        <button id="btnExportarPDF" class="btn btn-danger"><i class="fa fa-file-pdf me-1"></i> Exportar PDF</button>
    </div>
    <div id="reportePDF">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-danger text-white"><i class="fa fa-exclamation-triangle me-2"></i>Medicamentos en Stock Crítico</div>
                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Medicamento</th>
                                        <th>Stock Actual</th>
                                        <th>Stock Mínimo</th>
                                        <th>Vencimiento</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla_stock_critico">
                                    <tr><td colspan="4" class="text-center text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark"><i class="fa fa-clock me-2"></i>Próximos a Vencer (&lt; 30 días)</div>
                    <div class="card-body p-2">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Medicamento</th>
                                        <th>Vencimiento</th>
                                        <th>Stock</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla_proximos_vencer">
                                    <tr><td colspan="3" class="text-center text-muted">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white"><i class="fa fa-chart-bar me-2"></i>Medicamentos en Riesgo</div>
            <div class="card-body">
                <canvas id="grafico_riesgo" height="100"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script src="/static/js/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
function cargarDatosStockCritico() {
    $.getJSON(window.location.pathname, {ajax: 1}, function(resp) {
        // Stock crítico
        let filas = '';
        if(resp.stock_critico.length === 0) {
            filas = '<tr><td colspan="4" class="text-center text-success">No hay medicamentos en stock crítico.</td></tr>';
        } else {
            resp.stock_critico.forEach(function(m) {
                filas += `<tr><td>${m.nombre_comercial}</td><td>${m.stock_actual}</td><td>${m.stock_minimo}</td><td>${m.fecha_vencimiento || '-'}</td></tr>`;
            });
        }
        $('#tabla_stock_critico').html(filas);
        // Próximos a vencer
        let filas2 = '';
        if(resp.proximos_vencer.length === 0) {
            filas2 = '<tr><td colspan="3" class="text-center text-success">No hay medicamentos próximos a vencer.</td></tr>';
        } else {
            resp.proximos_vencer.forEach(function(m) {
                filas2 += `<tr><td>${m.nombre_comercial}</td><td>${m.fecha_vencimiento}</td><td>${m.stock_actual}</td></tr>`;
            });
        }
        $('#tabla_proximos_vencer').html(filas2);
        // Gráfico
        if(window.graficoRiesgo) window.graficoRiesgo.destroy();
        window.graficoRiesgo = new Chart(document.getElementById('grafico_riesgo'), {
            type: 'bar',
            data: {
                labels: resp.grafico.labels,
                datasets: [{
                    label: 'Stock actual',
                    data: resp.grafico.data,
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: 'Medicamentos en riesgo (stock crítico o próximos a vencer)'
                    }
                },
                scales: {
                    x: { title: { display: true, text: 'Medicamento' } },
                    y: { title: { display: true, text: 'Stock actual' }, beginAtZero: true }
                }
            }
        });
    });
}
function exportarPDF() {
    // Convertir el canvas a imagen antes de exportar
    let canvas = document.getElementById('grafico_riesgo');
    let imgData = canvas.toDataURL('image/png');
    // Clonar el contenido del reporte
    let $reporte = $('#reportePDF').clone();
    // Reemplazar el canvas por la imagen en el clon
    $reporte.find('#grafico_riesgo').replaceWith(`<img src='${imgData}' style='width:100%;max-width:700px;margin:auto;display:block;'>`);
    // Opciones para html2pdf
    let opt = {
        margin:       0.5,
        filename:     'reporte_stock_critico.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from($reporte[0]).save();
}
$(function() {
    cargarDatosStockCritico();
    $('#btnExportarPDF').click(exportarPDF);
});
</script>
{% endblock %} 