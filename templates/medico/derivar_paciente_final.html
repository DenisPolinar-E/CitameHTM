{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Derivar a Especialista - Hospital Tingo María{% endblock %}

{% block content %}
    <!-- Contenido principal -->
    <div class="container-fluid">
        <div class="content-header">
            <h2><i class="fas fa-exchange-alt me-2"></i>Derivar a Especialista</h2>
        </div>
            
        <div class="row">
            <!-- Datos del paciente -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-user me-2"></i>Datos del Paciente</h5>
                    </div>
                    <div class="card-body">
                        <div class="patient-info">
                            <h4>{{ cita.paciente.usuario.nombres }} {{ cita.paciente.usuario.apellidos }}</h4>
                            <p><strong>DNI:</strong> {{ cita.paciente.usuario.dni }}</p>
                            <p><strong>Edad:</strong> 
                                {% if cita.paciente.usuario.fecha_nacimiento %}
                                    {{ cita.paciente.usuario.fecha_nacimiento|timesince }}
                                {% else %}
                                    No registrada
                                {% endif %}
                            </p>
                            <p><strong>Teléfono:</strong> {{ cita.paciente.usuario.telefono|default:"No registrado" }}</p>
                            <p><strong>Dirección:</strong> {{ cita.paciente.usuario.direccion|default:"No registrada" }}</p>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Datos de la Cita</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Fecha:</strong> {{ cita.fecha|date:"d/m/Y" }}</p>
                        <p><strong>Hora:</strong> {{ cita.hora_inicio|time:"H:i" }} - {{ cita.hora_fin|time:"H:i" }}</p>
                        <p><strong>Consultorio:</strong> {{ cita.consultorio.codigo }}</p>
                        <p><strong>Motivo:</strong> {{ cita.motivo }}</p>
                        <p><strong>Estado:</strong> <span class="badge bg-{{ cita.estado }}">{{ cita.get_estado_display }}</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Formulario de derivación -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Formulario de Derivación</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'derivar_paciente' cita.id %}" id="derivacionForm">
                            {% csrf_token %}
                            <input type="hidden" name="accion" value="derivar">
                            
                            <div class="mb-3">
                                <label for="especialidad" class="form-label">Especialidad</label>
                                <select class="form-select" id="especialidad" name="especialidad" required>
                                    <option value="">Seleccione una especialidad</option>
                                    {% for especialidad in especialidades %}
                                        <option value="{{ especialidad.id }}">{{ especialidad.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="motivo_derivacion" class="form-label">Motivo de derivación</label>
                                <textarea class="form-control" id="motivo_derivacion" name="motivo_derivacion" rows="4" required></textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="vigencia_dias" class="form-label">Vigencia (días)</label>
                                <input type="number" class="form-control" id="vigencia_dias" name="vigencia_dias" value="30" min="1" max="90">
                                <div class="form-text">Número de días en que esta derivación será válida para agendar una cita.</div>
                            </div>
                        
                            <!-- Sección de agendamiento de cita -->
                            <h4 class="mt-4">Agendar Cita con Especialista</h4>
                            <div id="seccion-agendamiento" class="card mt-2 mb-3 border-success" style="display: block;">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Agendar Cita con Especialista</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="medico_especialista" class="form-label">Médico Especialista</label>
                                        <select class="form-select" id="medico_especialista" name="medico_especialista">
                                            <option value="">Seleccione una especialidad primero</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="fecha_cita" class="form-label">Fecha de Cita</label>
                                        <input type="date" class="form-control" id="fecha_cita" name="fecha_cita">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="horario_cita" class="form-label">Horario Disponible</label>
                                        <select class="form-select" id="horario_cita" name="horario_cita">
                                            <option value="">Seleccione médico y fecha primero</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="consultorio" class="form-label">Consultorio</label>
                                        <input type="text" class="form-control" id="consultorio" name="consultorio" readonly>
                                    </div>
                                    
                                    <div class="form-text text-muted">
                                        <strong>Nota:</strong> El agendamiento de cita es opcional. Si no se agenda ahora, el paciente deberá hacerlo posteriormente.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-exchange-alt me-1"></i> Derivar y Agendar Cita
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/derivar_paciente.js' %}"></script>
{% endblock %}
