{% extends 'dashboard/base_dashboard.html' %}

{% block title %}Historial Médico - Hospital Tingo María{% endblock %}

{% block page_title %}Historial Médico{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Buscador de Pacientes -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-search me-2"></i> Buscar Paciente</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{% url 'historial_medico' %}" class="row g-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-primary text-white">
                            <i class="fas fa-user-injured"></i>
                        </span>
                        <input type="text" name="q" class="form-control" placeholder="Buscar por nombre, apellido o DNI" value="{{ query }}">
                    </div>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i> Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    {% if resultados_busqueda %}
        <!-- Resultados de búsqueda -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i> Resultados de Búsqueda</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>DNI</th>
                                <th>Nombre</th>
                                <th>Apellidos</th>
                                <th>Edad</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for paciente in resultados_busqueda %}
                            <tr>
                                <td>{{ paciente.usuario.dni }}</td>
                                <td>{{ paciente.usuario.nombres }}</td>
                                <td>{{ paciente.usuario.apellidos }}</td>
                                <td>{{ paciente.usuario.edad }} años</td>
                                <td>
                                    <a href="{% url 'historial_medico' %}?paciente_id={{ paciente.id }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-folder-open me-1"></i> Ver Historial
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
    
    {% if paciente %}
        <!-- Información del Paciente -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user-circle me-2"></i> Información del Paciente</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <p class="mb-1 text-muted">Nombre completo:</p>
                        <h5>{{ paciente.usuario.nombres }} {{ paciente.usuario.apellidos }}</h5>
                    </div>
                    <div class="col-md-2 mb-3">
                        <p class="mb-1 text-muted">DNI:</p>
                        <h5>{{ paciente.usuario.dni }}</h5>
                    </div>
                    <div class="col-md-2 mb-3">
                        <p class="mb-1 text-muted">Edad:</p>
                        <h5>{{ paciente.usuario.edad }} años</h5>
                    </div>
                    <div class="col-md-2 mb-3">
                        <p class="mb-1 text-muted">Sexo:</p>
                        <h5>{{ paciente.usuario.get_sexo_display }}</h5>
                    </div>
                    <div class="col-md-2 mb-3">
                        <p class="mb-1 text-muted">Teléfono:</p>
                        <h5>{{ paciente.usuario.telefono }}</h5>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1 text-muted">Dirección:</p>
                        <h5>{{ paciente.usuario.direccion }}</h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <p class="mb-1 text-muted">Estado:</p>
                        <span class="badge {% if paciente.estado_reserva == 'activo' %}bg-success{% elif paciente.estado_reserva == 'bloqueado' %}bg-danger{% else %}bg-warning{% endif %} p-2">
                            {{ paciente.get_estado_reserva_display }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pestañas para diferentes secciones -->
        <ul class="nav nav-tabs mb-4" id="historialTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="historial-tab" data-bs-toggle="tab" data-bs-target="#historial-tab-pane" type="button" role="tab" aria-controls="historial-tab-pane" aria-selected="true">
                    <i class="fas fa-clipboard-list me-1"></i> Historial Médico
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="derivaciones-tab" data-bs-toggle="tab" data-bs-target="#derivaciones-tab-pane" type="button" role="tab" aria-controls="derivaciones-tab-pane" aria-selected="false">
                    <i class="fas fa-exchange-alt me-1"></i> Derivaciones
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="citas-tab" data-bs-toggle="tab" data-bs-target="#citas-tab-pane" type="button" role="tab" aria-controls="citas-tab-pane" aria-selected="false">
                    <i class="fas fa-calendar-check me-1"></i> Citas Previas
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="historialTabContent">
            <!-- Historial Médico Tab -->
            <div class="tab-pane fade show active" id="historial-tab-pane" role="tabpanel" aria-labelledby="historial-tab" tabindex="0">
                {% if historial %}
                    {% for registro in historial %}
                        <div class="card mb-3 border-left-primary">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">
                                    <i class="fas fa-calendar-day me-2"></i> 
                                    <strong>Fecha:</strong> {{ registro.fecha|date:"d/m/Y" }}
                                </h6>
                                <span class="badge bg-primary">
                                    {{ registro.fecha|date:"H:i" }}
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6 class="text-primary"><i class="fas fa-stethoscope me-2"></i> Diagnóstico:</h6>
                                        <p class="border-bottom pb-2">{{ registro.diagnostico }}</p>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h6 class="text-success"><i class="fas fa-prescription-bottle-alt me-2"></i> Tratamiento:</h6>
                                        <p class="border-bottom pb-2">{{ registro.tratamiento }}</p>
                                    </div>
                                </div>
                                {% if registro.observaciones %}
                                <div class="row">
                                    <div class="col-md-12">
                                        <h6 class="text-info"><i class="fas fa-comment-medical me-2"></i> Observaciones:</h6>
                                        <p>{{ registro.observaciones }}</p>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> No hay registros de historial médico para este paciente.
                    </div>
                {% endif %}
            </div>
            
            <!-- Derivaciones Tab -->
            <div class="tab-pane fade" id="derivaciones-tab-pane" role="tabpanel" aria-labelledby="derivaciones-tab" tabindex="0">
                {% if derivaciones %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Especialidad</th>
                                    <th>Motivo</th>
                                    <th>Vigencia</th>
                                    <th>Estado</th>
                                    <th>Cita Agendada</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for derivacion in derivaciones %}
                                <tr>
                                    <td>{{ derivacion.fecha_derivacion|date:"d/m/Y" }}</td>
                                    <td>{{ derivacion.especialidad_destino.nombre }}</td>
                                    <td>{{ derivacion.motivo }}</td>
                                    <td>{{ derivacion.vigencia_dias }} días</td>
                                    <td>
                                        <span class="badge 
                                            {% if derivacion.estado == 'pendiente' %}bg-warning
                                            {% elif derivacion.estado == 'usada' %}bg-success
                                            {% else %}bg-secondary{% endif %}">
                                            {{ derivacion.get_estado_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if derivacion.cita_agendada %}
                                            <span class="badge bg-success">Sí</span>
                                        {% else %}
                                            <span class="badge bg-danger">No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> No hay derivaciones registradas para este paciente.
                    </div>
                {% endif %}
            </div>
            
            <!-- Citas Previas Tab -->
            <div class="tab-pane fade" id="citas-tab-pane" role="tabpanel" aria-labelledby="citas-tab" tabindex="0">
                {% if citas_previas %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Horario</th>
                                    <th>Consultorio</th>
                                    <th>Motivo</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cita in citas_previas %}
                                <tr>
                                    <td>{{ cita.fecha|date:"d/m/Y" }}</td>
                                    <td>{{ cita.hora_inicio|time:"H:i" }} - {{ cita.hora_fin|time:"H:i" }}</td>
                                    <td>{{ cita.consultorio.codigo }}</td>
                                    <td>{{ cita.motivo }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if cita.estado == 'atendida' %}bg-success
                                            {% elif cita.estado == 'cancelada' %}bg-danger
                                            {% else %}bg-warning{% endif %}">
                                            {{ cita.get_estado_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <a href="{% url 'atender_paciente' cita.id %}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-eye me-1"></i> Ver Detalle
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> No hay citas previas registradas para este paciente.
                    </div>
                {% endif %}
            </div>
        </div>
    {% elif not resultados_busqueda and query %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i> No se encontraron pacientes que coincidan con el criterio de búsqueda.
        </div>
    {% elif not query %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> Utiliza el buscador para encontrar un paciente y ver su historial médico.
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Activar tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    })
</script>
{% endblock %}
