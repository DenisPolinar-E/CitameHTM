{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Historial de Movimientos - CitaMe{% endblock %}

{% block page_title %}Historial de Movimientos{% endblock %}

{% block sidebar_menu %}
<a href="{% url 'dashboard_farmacia' %}" class="menu-item"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
<a href="{% url 'recetas_pendientes' %}" class="menu-item"><i class="fas fa-prescription"></i> Recetas Pendientes</a>

<!-- Menú expandible de Inventario -->
<div class="menu-item dropdown-menu-item">
    <a href="#" class="menu-item-toggle active"><i class="fas fa-boxes"></i> Inventario <i class="fas fa-chevron-down"></i></a>
    <div class="submenu active">
        <a href="{% url 'inventario_medicamentos' %}" class="submenu-item"><i class="fas fa-pills"></i> Ver Inventario</a>
        <a href="{% url 'entrada_medicamentos' %}" class="submenu-item"><i class="fas fa-plus-circle"></i> Entrada de Medicamentos</a>
        <a href="{% url 'ajuste_inventario' %}" class="submenu-item"><i class="fas fa-adjust"></i> Ajuste de Stock</a>
        <a href="{% url 'historial_movimientos' %}" class="submenu-item active"><i class="fas fa-history"></i> Historial de Movimientos</a>
        <a href="{% url 'reporte_inventario' %}" class="submenu-item"><i class="fas fa-chart-bar"></i> Reporte de Inventario</a>
    </div>
</div>

<a href="{% url 'alertas_farmacia' %}" class="menu-item"><i class="fas fa-exclamation-triangle"></i> Alertas</a>
<a href="{% url 'perfil_admin' %}" class="menu-item"><i class="fas fa-user"></i> Mi Perfil</a>
{% endblock %}

{% block extra_css %}
<style>
    .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .filter-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 15px;
        margin-bottom: 2rem;
    }

    .movimiento-entrada {
        border-left: 4px solid #26de81;
        background-color: #f8fff9;
    }

    .movimiento-salida {
        border-left: 4px solid #ff4757;
        background-color: #fff8f8;
    }

    .badge-entrada {
        background-color: #26de81;
        color: white;
    }

    .badge-salida {
        background-color: #ff4757;
        color: white;
    }

    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }

    .btn-custom {
        border-radius: 25px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-end align-items-center mb-4">
        <a href="{% url 'inventario_medicamentos' %}" class="btn btn-secondary btn-custom">
            <i class="fas fa-arrow-left"></i> Volver al Inventario
        </a>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card">
                <div class="text-center">
                    <i class="fas fa-arrow-up fa-2x mb-2"></i>
                    <h3 class="mb-0">{{ total_entradas }}</h3>
                    <p class="mb-0">Entradas</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card">
                <div class="text-center">
                    <i class="fas fa-arrow-down fa-2x mb-2"></i>
                    <h3 class="mb-0">{{ total_salidas }}</h3>
                    <p class="mb-0">Salidas</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card">
                <div class="text-center">
                    <i class="fas fa-exchange-alt fa-2x mb-2"></i>
                    <h3 class="mb-0">{{ total_entradas|add:total_salidas }}</h3>
                    <p class="mb-0">Total Movimientos</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-section">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <select class="form-select" name="medicamento">
                    <option value="">Todos los medicamentos</option>
                    {% for medicamento in medicamentos %}
                        <option value="{{ medicamento.id }}" {% if medicamento_id == medicamento.id|stringformat:"s" %}selected{% endif %}>
                            {{ medicamento.nombre_comercial }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="tipo">
                    <option value="">Todos los tipos</option>
                    <option value="entrada" {% if tipo_movimiento == 'entrada' %}selected{% endif %}>Entrada</option>
                    <option value="salida" {% if tipo_movimiento == 'salida' %}selected{% endif %}>Salida</option>
                    <option value="ajuste_positivo" {% if tipo_movimiento == 'ajuste_positivo' %}selected{% endif %}>Ajuste +</option>
                    <option value="ajuste_negativo" {% if tipo_movimiento == 'ajuste_negativo' %}selected{% endif %}>Ajuste -</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="date" class="form-control" name="fecha_desde" value="{{ fecha_desde }}">
            </div>
            <div class="col-md-2">
                <input type="date" class="form-control" name="fecha_hasta" value="{{ fecha_hasta }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-light btn-custom">
                    <i class="fas fa-search"></i> Filtrar
                </button>
                <a href="{% url 'historial_movimientos' %}" class="btn btn-outline-light btn-custom">
                    <i class="fas fa-times"></i> Limpiar
                </a>
            </div>
        </form>
    </div>

    <!-- Tabla de movimientos -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Medicamento</th>
                            <th>Tipo</th>
                            <th>Cantidad</th>
                            <th>Stock</th>
                            <th>Usuario</th>
                            <th>Motivo</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for movimiento in movimientos %}
                        <tr class="{% if movimiento.es_entrada %}movimiento-entrada{% else %}movimiento-salida{% endif %}">
                            <td>
                                <div class="fw-bold">{{ movimiento.fecha_movimiento|date:"d/m/Y" }}</div>
                                <small class="text-muted">{{ movimiento.fecha_movimiento|date:"H:i" }}</small>
                            </td>
                            <td>
                                <div class="fw-bold">{{ movimiento.medicamento.nombre_comercial }}</div>
                                <small class="text-muted">{{ movimiento.medicamento.codigo }}</small>
                            </td>
                            <td>
                                <span class="badge {% if movimiento.es_entrada %}badge-entrada{% else %}badge-salida{% endif %}">
                                    {% if movimiento.es_entrada %}
                                        <i class="fas fa-arrow-up"></i>
                                    {% else %}
                                        <i class="fas fa-arrow-down"></i>
                                    {% endif %}
                                    {{ movimiento.get_tipo_movimiento_display }}
                                </span>
                            </td>
                            <td>
                                <span class="fw-bold {% if movimiento.es_entrada %}text-success{% else %}text-danger{% endif %}">
                                    {% if movimiento.es_entrada %}+{% else %}-{% endif %}{{ movimiento.cantidad }}
                                </span>
                            </td>
                            <td>
                                <div class="small">
                                    <span class="text-muted">{{ movimiento.stock_anterior }}</span>
                                    <i class="fas fa-arrow-right mx-1"></i>
                                    <span class="fw-bold">{{ movimiento.stock_nuevo }}</span>
                                </div>
                            </td>
                            <td>
                                {% if movimiento.usuario %}
                                    <div class="fw-bold">{{ movimiento.usuario.nombres }} {{ movimiento.usuario.apellidos }}</div>
                                    <small class="text-muted">{{ movimiento.usuario.rol.nombre }}</small>
                                {% else %}
                                    <span class="text-muted">Sistema</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="text-truncate" style="max-width: 200px;" title="{{ movimiento.motivo }}">
                                    {{ movimiento.motivo }}
                                </div>
                                {% if movimiento.lote_referencia %}
                                    <small class="text-muted d-block">Lote: {{ movimiento.lote_referencia }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="verDetalle({{ movimiento.id }})"
                                        title="Ver detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No hay movimientos registrados</h5>
                                <p class="text-muted">Los movimientos aparecerán aquí cuando se registren</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalle del movimiento -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle del Movimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detalle-contenido">
                    <!-- Contenido será cargado por JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function verDetalle(movimientoId) {
    // Aquí podrías hacer una llamada AJAX para obtener más detalles
    // Por ahora, solo mostramos el modal
    new bootstrap.Modal(document.getElementById('modalDetalle')).show();
}
</script>
{% endblock %} 