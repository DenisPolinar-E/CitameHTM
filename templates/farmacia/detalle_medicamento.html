{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}{{ medicamento.nombre_comercial }} - Detalle - CitaMe{% endblock %}

{% block page_title %}Detalle del Medicamento{% endblock %}

{% block sidebar_menu %}
<a href="{% url 'dashboard_farmacia' %}" class="menu-item"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
<a href="{% url 'recetas_pendientes' %}" class="menu-item"><i class="fas fa-prescription"></i> Recetas Pendientes</a>

<!-- Menú expandible de Inventario -->
<div class="menu-item dropdown-menu-item">
    <a href="#" class="menu-item-toggle active"><i class="fas fa-boxes"></i> Inventario <i class="fas fa-chevron-down"></i></a>
    <div class="submenu active">
        <a href="{% url 'inventario_medicamentos' %}" class="submenu-item"><i class="fas fa-pills"></i> Ver Inventario</a>
        <a href="{% url 'entrada_medicamentos' %}" class="submenu-item"><i class="fas fa-plus-circle"></i> Entrada de Medicamentos</a>
        <a href="{% url 'ajuste_inventario' %}" class="submenu-item"><i class="fas fa-adjust"></i> Ajuste de Stock</a>
        <a href="{% url 'historial_movimientos' %}" class="submenu-item"><i class="fas fa-history"></i> Historial de Movimientos</a>
        <a href="{% url 'reporte_inventario' %}" class="submenu-item"><i class="fas fa-chart-bar"></i> Reporte de Inventario</a>
    </div>
</div>

<a href="{% url 'alertas_farmacia' %}" class="menu-item"><i class="fas fa-exclamation-triangle"></i> Alertas</a>
<a href="{% url 'perfil_admin' %}" class="menu-item"><i class="fas fa-user"></i> Mi Perfil</a>
{% endblock %}

{% block extra_css %}
<style>
    .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .medicamento-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border: none;
        text-align: center;
        padding: 1.5rem;
    }

    .stat-card.warning {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-card.danger {
        background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
    }

    .stat-card.success {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }

    .movimiento-entrada {
        border-left: 4px solid #28a745;
        background-color: #f8fff9;
    }

    .movimiento-salida {
        border-left: 4px solid #dc3545;
        background-color: #fff8f8;
    }

    .progress-custom {
        height: 10px;
        border-radius: 10px;
        background-color: #e9ecef;
    }

    .btn-custom {
        border-radius: 25px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        margin: 0.25rem;
    }

    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }

    .badge-custom {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header del medicamento -->
    <div class="medicamento-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h2 class="mb-2">{{ medicamento.nombre_comercial }}</h2>
                <h5 class="mb-2 opacity-75">{{ medicamento.nombre_generico }}</h5>
                <p class="mb-0">
                    <span class="badge bg-light text-dark me-2">{{ medicamento.codigo }}</span>
                    <span class="badge bg-light text-dark me-2">{{ medicamento.concentracion }}</span>
                    <span class="badge bg-light text-dark">{{ medicamento.forma_farmaceutica|title }}</span>
                </p>
            </div>
            <div class="text-end">
                <a href="{% url 'inventario_medicamentos' %}" class="btn btn-light btn-custom">
                    <i class="fas fa-arrow-left"></i> Volver al Inventario
                </a>
            </div>
        </div>
    </div>

    <!-- Estadísticas principales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card {% if medicamento.stock_critico %}danger{% elif medicamento.stock_actual <= medicamento.stock_minimo|add:medicamento.stock_minimo %}warning{% else %}success{% endif %}">
                <div class="card-body">
                    <h3 class="mb-0">{{ medicamento.stock_actual }}</h3>
                    <p class="mb-0">Stock Actual</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <h3 class="mb-0">{{ medicamento.stock_minimo }}</h3>
                    <p class="mb-0">Stock Mínimo</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card success">
                <div class="card-body">
                    <h3 class="mb-0">{{ total_entradas }}</h3>
                    <p class="mb-0">Total Entradas</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card warning">
                <div class="card-body">
                    <h3 class="mb-0">{{ total_salidas }}</h3>
                    <p class="mb-0">Total Salidas</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Información del medicamento -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-primary"></i> Información del Medicamento
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Laboratorio:</strong>
                            <p class="mb-0">{{ medicamento.laboratorio }}</p>
                        </div>
                        <div class="col-6">
                            <strong>Precio Unitario:</strong>
                            <p class="mb-0">S/. {{ medicamento.precio_unitario }}</p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Fecha de Vencimiento:</strong>
                            <p class="mb-0 {% if medicamento.proximo_a_vencer %}text-danger{% endif %}">
                                {{ medicamento.fecha_vencimiento }}
                            </p>
                        </div>
                        <div class="col-6">
                            <strong>Días para vencer:</strong>
                            <p class="mb-0 {% if medicamento.proximo_a_vencer %}text-danger{% endif %}">
                                {{ medicamento.dias_para_vencer }} días
                            </p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Requiere Receta:</strong>
                            <p class="mb-0">
                                {% if medicamento.requiere_receta %}
                                    <span class="badge bg-warning">Sí</span>
                                {% else %}
                                    <span class="badge bg-info">No</span>
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-6">
                            <strong>Controlado:</strong>
                            <p class="mb-0">
                                {% if medicamento.controlado %}
                                    <span class="badge bg-danger">Sí</span>
                                {% else %}
                                    <span class="badge bg-success">No</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>

                    <!-- Progress bar del stock -->
                    <div class="mb-3">
                        <strong>Estado del Stock:</strong>
                        <div class="progress progress-custom mt-2">
                            {% with porcentaje=medicamento.stock_actual|floatformat:0 minimo=medicamento.stock_minimo|floatformat:0 %}
                                {% if medicamento.stock_actual <= medicamento.stock_minimo %}
                                    <div class="progress-bar bg-danger" style="width: 100%">
                                        Crítico
                                    </div>
                                {% elif medicamento.stock_actual <= medicamento.stock_minimo|add:medicamento.stock_minimo %}
                                    <div class="progress-bar bg-warning" style="width: 75%">
                                        Bajo
                                    </div>
                                {% else %}
                                    <div class="progress-bar bg-success" style="width: 100%">
                                        Normal
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Estadísticas de consumo -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line text-success"></i> Estadísticas de Consumo
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 class="text-primary">{{ dispensaciones_mes }}</h4>
                            <small class="text-muted">Dispensaciones (30 días)</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-success">{{ promedio_diario }}</h4>
                            <small class="text-muted">Promedio diario</small>
                        </div>
                        <div class="col-4">
                            <h4 class="text-warning">{{ dias_stock_estimado }}</h4>
                            <small class="text-muted">Días de stock</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movimientos recientes -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-info"></i> Movimientos Recientes
                    </h5>
                </div>
                <div class="card-body">
                    {% if movimientos_recientes %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Cantidad</th>
                                        <th>Usuario</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for movimiento in movimientos_recientes %}
                                    <tr class="{% if movimiento.es_entrada %}movimiento-entrada{% else %}movimiento-salida{% endif %}">
                                        <td>
                                            <small>{{ movimiento.fecha_movimiento|date:"d/m/Y" }}</small><br>
                                            <small class="text-muted">{{ movimiento.fecha_movimiento|date:"H:i" }}</small>
                                        </td>
                                        <td>
                                            <span class="badge badge-custom {% if movimiento.es_entrada %}bg-success{% else %}bg-danger{% endif %}">
                                                {% if movimiento.es_entrada %}
                                                    <i class="fas fa-arrow-up"></i>
                                                {% else %}
                                                    <i class="fas fa-arrow-down"></i>
                                                {% endif %}
                                                {{ movimiento.get_tipo_movimiento_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="fw-bold {% if movimiento.es_entrada %}text-success{% else %}text-danger{% endif %}">
                                                {% if movimiento.es_entrada %}+{% else %}-{% endif %}{{ movimiento.cantidad }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if movimiento.usuario %}
                                                {{ movimiento.usuario.nombres }} {{ movimiento.usuario.apellidos }}
                                            {% else %}
                                                <span class="text-muted">Sistema</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="text-center mt-3">
                            <a href="{% url 'historial_movimientos' %}?medicamento={{ medicamento.id }}" class="btn btn-outline-primary btn-custom">
                                <i class="fas fa-list"></i> Ver Historial Completo
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No hay movimientos registrados</h6>
                            <p class="text-muted">Los movimientos aparecerán aquí cuando se registren</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones rápidas -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <h6 class="mb-3">Acciones Rápidas</h6>
                    <button type="button" 
                            class="btn btn-success btn-custom"
                            onclick="modalEntrada({{ medicamento.id }}, '{{ medicamento.nombre_comercial }}')">
                        <i class="fas fa-plus"></i> Entrada Rápida
                    </button>
                    <button type="button" 
                            class="btn btn-warning btn-custom"
                            onclick="modalAjuste({{ medicamento.id }}, '{{ medicamento.nombre_comercial }}', {{ medicamento.stock_actual }})">
                        <i class="fas fa-adjust"></i> Ajuste Rápido
                    </button>
                    <a href="{% url 'historial_movimientos' %}?medicamento={{ medicamento.id }}" class="btn btn-info btn-custom">
                        <i class="fas fa-history"></i> Ver Historial
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modales (reutilizamos los del inventario principal) -->
{% include 'farmacia/modales_inventario.html' %}
{% endblock %}

{% block extra_js %}
<script>
function modalEntrada(medicamentoId, nombreMedicamento) {
    document.getElementById('entrada_medicamento_id').value = medicamentoId;
    document.getElementById('entrada_medicamento_nombre').value = nombreMedicamento;
    new bootstrap.Modal(document.getElementById('modalEntrada')).show();
}

function modalAjuste(medicamentoId, nombreMedicamento, stockActual) {
    document.getElementById('ajuste_medicamento_id').value = medicamentoId;
    document.getElementById('ajuste_medicamento_nombre').value = nombreMedicamento;
    document.getElementById('ajuste_stock_actual').value = stockActual + ' unidades';
    new bootstrap.Modal(document.getElementById('modalAjuste')).show();
}
</script>
{% endblock %} 