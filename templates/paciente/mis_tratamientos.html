{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Mis Tratamientos - Paciente{% endblock %}

{% block page_title %}Mis Tratamientos{% endblock %}

{% block sidebar_menu %}
<a href="{% url 'dashboard_paciente' %}" class="menu-item"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
<a href="{% url 'mis_citas' %}" class="menu-item"><i class="fas fa-calendar-check"></i> Mis Citas</a>
<a href="{% url 'reservar_cita' %}" class="menu-item"><i class="fas fa-calendar-plus"></i> Reservar Cita</a>
<a href="{% url 'mi_historial_medico' %}" class="menu-item"><i class="fas fa-file-medical"></i> Mi Historial</a>
<a href="{% url 'mis_tratamientos' %}" class="menu-item active"><i class="fas fa-clipboard-list"></i> Mis Tratamientos</a>
<a href="{% url 'perfil_paciente' %}" class="menu-item"><i class="fas fa-user"></i> Mi Perfil</a>
{% endblock %}

{% block extra_css %}
<style>
    .card {
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    .card-header {
        border-radius: 10px 10px 0 0 !important;
        font-weight: 600;
    }
    .tratamiento-card {
        transition: all 0.3s ease;
        cursor: pointer;
        border-left: 4px solid #1976d2;
    }
    .tratamiento-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .tratamiento-card.activo {
        border-left-color: #4caf50;
    }
    .tratamiento-card.terminado {
        border-left-color: #9e9e9e;
    }
    .tratamiento-card.cancelado {
        border-left-color: #f44336;
    }
    .badge-activo {
        background-color: #4caf50;
        color: white;
    }
    .badge-terminado {
        background-color: #9e9e9e;
        color: white;
    }
    .badge-cancelado {
        background-color: #f44336;
        color: white;
    }
    .progress {
        height: 10px;
        border-radius: 5px;
    }
    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }
    .empty-state i {
        font-size: 4rem;
        color: #e0e0e0;
        margin-bottom: 20px;
    }
    .tab-content {
        padding-top: 20px;
    }
    .doctor-info {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .doctor-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
    }
    .doctor-avatar i {
        color: #757575;
    }
    .next-session {
        background-color: #e8f5e9;
        border-radius: 5px;
        padding: 15px;
        margin-top: 15px;
        border-left: 4px solid #4caf50;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <ul class="nav nav-tabs" id="tratamientosTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="activos-tab" data-bs-toggle="tab" data-bs-target="#activos" type="button" role="tab" aria-controls="activos" aria-selected="true">
                        <i class="fas fa-spinner me-2"></i> Tratamientos Activos
                        {% if tratamientos_activos %}
                            <span class="badge bg-primary ms-2">{{ tratamientos_activos|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="completados-tab" data-bs-toggle="tab" data-bs-target="#completados" type="button" role="tab" aria-controls="completados" aria-selected="false">
                        <i class="fas fa-check-circle me-2"></i> Tratamientos Completados
                        {% if tratamientos_completados %}
                            <span class="badge bg-secondary ms-2">{{ tratamientos_completados|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cancelados-tab" data-bs-toggle="tab" data-bs-target="#cancelados" type="button" role="tab" aria-controls="cancelados" aria-selected="false">
                        <i class="fas fa-times-circle me-2"></i> Tratamientos Cancelados
                        {% if tratamientos_cancelados %}
                            <span class="badge bg-danger ms-2">{{ tratamientos_cancelados|length }}</span>
                        {% endif %}
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="tratamientosTabContent">
                <!-- Tratamientos Activos -->
                <div class="tab-pane fade show active" id="activos" role="tabpanel" aria-labelledby="activos-tab">
                    {% if tratamientos_activos %}
                        <div class="row">
                            {% for tratamiento in tratamientos_activos %}
                                <div class="col-md-6">
                                    <div class="card tratamiento-card {{ tratamiento.estado }}" onclick="window.location.href='{% url 'detalle_seguimiento' tratamiento.id %}'">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h5 class="mb-0">{{ tratamiento.diagnostico|truncatechars:50 }}</h5>
                                                <span class="badge badge-{{ tratamiento.estado }}">{{ tratamiento.get_estado_display }}</span>
                                            </div>
                                            
                                            <div class="doctor-info">
                                                <div class="doctor-avatar">
                                                    <i class="fas fa-user-md"></i>
                                                </div>
                                                <div>
                                                    <strong>Dr. {{ tratamiento.medico.usuario.nombres }} {{ tratamiento.medico.usuario.apellidos }}</strong><br>
                                                    <small class="text-muted">{{ tratamiento.medico.especialidad.nombre }}</small>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">Inicio: {{ tratamiento.fecha_inicio|date:"d/m/Y" }}</small>
                                                <small class="text-muted">Fin estimado: {{ tratamiento.fecha_fin_estimada|date:"d/m/Y"|default:"No disponible" }}</small>
                                            </div>
                                            
                                            <div class="progress mb-2">
                                                <div class="progress-bar bg-primary" role="progressbar" style="width: {{ tratamiento.progreso }}%;" aria-valuenow="{{ tratamiento.progreso }}" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between">
                                                <small>{{ tratamiento.sesiones_completadas }} de {{ tratamiento.cantidad_sesiones }} sesiones completadas</small>
                                                <small>{{ tratamiento.progreso }}% completado</small>
                                            </div>
                                            
                                            {% for sesion in tratamiento.sesiones.all %}
                                                {% if sesion.estado == 'programada' and forloop.counter == 1 %}
                                                    <div class="next-session">
                                                        <strong><i class="fas fa-calendar-day me-2"></i> Próxima sesión:</strong>
                                                        <p class="mb-0">{{ sesion.cita.fecha|date:"d/m/Y" }} a las {{ sesion.cita.hora_inicio|time:"H:i" }}</p>
                                                        <small>Consultorio: {{ sesion.cita.consultorio.codigo }}</small>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h4>No tiene tratamientos activos</h4>
                            <p class="text-muted">Actualmente no tiene tratamientos en curso.</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Tratamientos Completados -->
                <div class="tab-pane fade" id="completados" role="tabpanel" aria-labelledby="completados-tab">
                    {% if tratamientos_completados %}
                        <div class="row">
                            {% for tratamiento in tratamientos_completados %}
                                <div class="col-md-6">
                                    <div class="card tratamiento-card {{ tratamiento.estado }}" onclick="window.location.href='{% url 'detalle_seguimiento' tratamiento.id %}'">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h5 class="mb-0">{{ tratamiento.diagnostico|truncatechars:50 }}</h5>
                                                <span class="badge badge-{{ tratamiento.estado }}">{{ tratamiento.get_estado_display }}</span>
                                            </div>
                                            
                                            <div class="doctor-info">
                                                <div class="doctor-avatar">
                                                    <i class="fas fa-user-md"></i>
                                                </div>
                                                <div>
                                                    <strong>Dr. {{ tratamiento.medico.usuario.nombres }} {{ tratamiento.medico.usuario.apellidos }}</strong><br>
                                                    <small class="text-muted">{{ tratamiento.medico.especialidad.nombre }}</small>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">Inicio: {{ tratamiento.fecha_inicio|date:"d/m/Y" }}</small>
                                                <small class="text-muted">Fin: {{ tratamiento.updated_at|date:"d/m/Y" }}</small>
                                            </div>
                                            
                                            <div class="progress mb-2">
                                                <div class="progress-bar bg-success" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between">
                                                <small>{{ tratamiento.sesiones_completadas }} de {{ tratamiento.cantidad_sesiones }} sesiones completadas</small>
                                                <small>100% completado</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-clipboard-check"></i>
                            <h4>No tiene tratamientos completados</h4>
                            <p class="text-muted">Aún no ha completado ningún tratamiento.</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Tratamientos Cancelados -->
                <div class="tab-pane fade" id="cancelados" role="tabpanel" aria-labelledby="cancelados-tab">
                    {% if tratamientos_cancelados %}
                        <div class="row">
                            {% for tratamiento in tratamientos_cancelados %}
                                <div class="col-md-6">
                                    <div class="card tratamiento-card cancelado" onclick="window.location.href='{% url 'detalle_seguimiento' tratamiento.id %}';">                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h5 class="card-title mb-0">{{ tratamiento.diagnostico|truncatechars:50 }}</h5>
                                                <span class="badge badge-cancelado">Cancelado</span>
                                            </div>
                                            
                                            <div class="doctor-info">
                                                <div class="doctor-avatar">
                                                    <i class="fas fa-user-md"></i>
                                                </div>
                                                <div>
                                                    <p class="mb-0">Dr. {{ tratamiento.medico.usuario.nombres }} {{ tratamiento.medico.usuario.apellidos }}</p>
                                                    <small class="text-muted">{{ tratamiento.medico.especialidad.nombre }}</small>
                                                </div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-muted">Inicio: {{ tratamiento.fecha_inicio|date:"d/m/Y" }}</small>
                                                <small class="text-muted">Cancelado: {{ tratamiento.updated_at|date:"d/m/Y" }}</small>
                                            </div>
                                            
                                            <div class="progress mb-2">
                                                <div class="progress-bar bg-danger" role="progressbar" style="width: {{ tratamiento.progreso }}%;" aria-valuenow="{{ tratamiento.progreso }}" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                            
                                            <div class="d-flex justify-content-between">
                                                <small>{{ tratamiento.sesiones_completadas }} de {{ tratamiento.cantidad_sesiones }} sesiones completadas</small>
                                                <small>{{ tratamiento.progreso }}% completado</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-ban"></i>
                            <h4>No tiene tratamientos cancelados</h4>
                            <p class="text-muted">No se ha cancelado ningún tratamiento.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <i class="fas fa-info-circle me-2"></i> Información sobre sus tratamientos
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>¿Qué son los tratamientos con seguimiento?</h5>
                            <p>Los tratamientos con seguimiento son planes de atención médica que requieren múltiples sesiones para lograr los resultados esperados.</p>
                            
                            <h5>Beneficios del seguimiento</h5>
                            <ul>
                                <li>Atención médica continua y personalizada</li>
                                <li>Seguimiento estructurado de su evolución</li>
                                <li>Mayor efectividad del tratamiento</li>
                                <li>Ajustes oportunos según su respuesta</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>Recomendaciones</h5>
                            <ul>
                                <li>Asista a todas sus sesiones programadas</li>
                                <li>Siga las indicaciones médicas entre sesiones</li>
                                <li>Informe cualquier cambio en su condición</li>
                                <li>Si no puede asistir a una cita, notifique con anticipación</li>
                            </ul>
                            
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Importante:</strong> La efectividad del tratamiento depende en gran medida de su adherencia al plan establecido por su médico.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
