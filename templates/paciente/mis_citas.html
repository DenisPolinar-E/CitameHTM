{% extends 'dashboard/base_dashboard.html' %}

{% block title %}Mis Citas - Hospital Tingo María{% endblock %}

{% block page_title %}Mis Citas{% endblock %}

{% block sidebar_menu %}
<a href="{% url 'dashboard_paciente' %}" class="menu-item"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
<a href="{% url 'mis_citas' %}" class="menu-item active"><i class="fas fa-calendar-check"></i> Mis Citas</a>
<a href="{% url 'reservar_cita' %}" class="menu-item"><i class="fas fa-calendar-plus"></i> Reservar Cita</a>
<a href="{% url 'mi_historial_medico' %}" class="menu-item"><i class="fas fa-file-medical-alt"></i> Mi Historial</a>
<a href="{% url 'mis_tratamientos' %}" class="menu-item"><i class="fas fa-clipboard-list"></i> Mis Tratamientos</a>
<a href="{% url 'perfil_paciente' %}" class="menu-item"><i class="fas fa-user"></i> Mi Perfil</a>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Tarjeta de estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card h-100 border-left-primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3 text-center">
                            <i class="fas fa-calendar-alt text-primary" style="font-size: 2rem;"></i>
                        </div>
                        <div class="col-9">
                            <h2 class="mb-0">{{ total_citas }}</h2>
                            <p class="text-muted mb-0">Total de Citas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card h-100 border-left-warning">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3 text-center">
                            <i class="fas fa-clock text-warning" style="font-size: 2rem;"></i>
                        </div>
                        <div class="col-9">
                            <h2 class="mb-0">{{ citas_pendientes }}</h2>
                            <p class="text-muted mb-0">Citas Pendientes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card h-100 border-left-success">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3 text-center">
                            <i class="fas fa-check-circle text-success" style="font-size: 2rem;"></i>
                        </div>
                        <div class="col-9">
                            <h2 class="mb-0">{{ citas_completadas }}</h2>
                            <p class="text-muted mb-0">Citas Completadas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card h-100 border-left-danger">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-3 text-center">
                            <i class="fas fa-times-circle text-danger" style="font-size: 2rem;"></i>
                        </div>
                        <div class="col-9">
                            <h2 class="mb-0">{{ citas_canceladas }}</h2>
                            <p class="text-muted mb-0">Citas Canceladas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-5">
                    <label for="estado" class="form-label">Estado</label>
                    <select class="form-select" id="estado" name="estado">
                        <option value="todas" {% if estado_filtro == 'todas' %}selected{% endif %}>Todas</option>
                        <option value="pendiente" {% if estado_filtro == 'pendiente' %}selected{% endif %}>Pendientes</option>
                        <option value="confirmada" {% if estado_filtro == 'confirmada' %}selected{% endif %}>Confirmadas</option>
                        <option value="atendida" {% if estado_filtro == 'atendida' %}selected{% endif %}>Atendidas</option>
                        <option value="cancelada" {% if estado_filtro == 'cancelada' %}selected{% endif %}>Canceladas</option>
                    </select>
                </div>
                <div class="col-md-5">
                    <label for="fecha" class="form-label">Fecha</label>
                    <select class="form-select" id="fecha" name="fecha">
                        <option value="todas" {% if fecha_filtro == 'todas' %}selected{% endif %}>Todas</option>
                        <option value="pendientes" {% if fecha_filtro == 'pendientes' %}selected{% endif %}>Próximas</option>
                        <option value="pasadas" {% if fecha_filtro == 'pasadas' %}selected{% endif %}>Pasadas</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Filtrar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Listado de citas en tarjetas -->
    <div class="row">
        {% if citas %}
            {% for cita in citas %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100 cita-card" data-bs-toggle="modal" data-bs-target="#citaModal{{ cita.id }}">
                        <div class="card-header 
                            {% if cita.estado == 'pendiente' %}bg-warning text-dark
                            {% elif cita.estado == 'confirmada' %}bg-info text-white
                            {% elif cita.estado == 'atendida' %}bg-success text-white
                            {% elif cita.estado == 'cancelada' %}bg-danger text-white
                            {% endif %}">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar-check me-2"></i>
                                {{ cita.medico.especialidad.nombre }}
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-3">
                                <div>
                                    <h6 class="text-muted mb-1">Fecha</h6>
                                    <p class="mb-0">{{ cita.fecha|date:"d/m/Y" }}</p>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">Hora</h6>
                                    <p class="mb-0">{{ cita.hora_inicio|time:"H:i" }}</p>
                                </div>
                                <div>
                                    <h6 class="text-muted mb-1">Estado</h6>
                                    <span class="badge 
                                        {% if cita.estado == 'pendiente' %}bg-warning
                                        {% elif cita.estado == 'confirmada' %}bg-info
                                        {% elif cita.estado == 'atendida' %}bg-success
                                        {% elif cita.estado == 'cancelada' %}bg-danger
                                        {% endif %}">
                                        {{ cita.get_estado_display }}
                                    </span>
                                </div>
                            </div>
                            <h6 class="text-muted mb-1">Médico</h6>
                            <p class="mb-3">Dr. {{ cita.medico.usuario.nombres }} {{ cita.medico.usuario.apellidos }}</p>
                            
                            <h6 class="text-muted mb-1">Consultorio</h6>
                            <p class="mb-0">{{ cita.medico.consultorio }}</p>
                        </div>
                        <div class="card-footer bg-white">
                            <small class="text-muted hover-details" style="opacity: 0;">
                                <i class="fas fa-info-circle me-1"></i> 
                                Haga clic para ver más detalles
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Modal para detalles de la cita -->
                <div class="modal fade" id="citaModal{{ cita.id }}" tabindex="-1" aria-labelledby="citaModalLabel{{ cita.id }}" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header 
                                {% if cita.estado == 'pendiente' %}bg-warning text-dark
                                {% elif cita.estado == 'confirmada' %}bg-info text-white
                                {% elif cita.estado == 'atendida' %}bg-success text-white
                                {% elif cita.estado == 'cancelada' %}bg-danger text-white
                                {% endif %}">
                                <h5 class="modal-title" id="citaModalLabel{{ cita.id }}">
                                    <i class="fas fa-calendar-check me-2"></i>
                                    Detalles de la Cita - {{ cita.medico.especialidad.nombre }}
                                </h5>
                                <button type="button" class="btn-close {% if cita.estado != 'pendiente' %}btn-close-white{% endif %}" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <h6 class="text-muted mb-2">Información de la Cita</h6>
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <h6 class="text-muted mb-1">Fecha</h6>
                                                            <p class="mb-0">{{ cita.fecha|date:"d/m/Y" }}</p>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6 class="text-muted mb-1">Hora</h6>
                                                            <p class="mb-0">{{ cita.hora_inicio|time:"H:i" }} - {{ cita.hora_fin|time:"H:i" }}</p>
                                                        </div>
                                                    </div>
                                                    <div class="row mb-3">
                                                        <div class="col-md-6">
                                                            <h6 class="text-muted mb-1">Estado</h6>
                                                            <span class="badge 
                                                                {% if cita.estado == 'pendiente' %}bg-warning
                                                                {% elif cita.estado == 'confirmada' %}bg-info
                                                                {% elif cita.estado == 'atendida' %}bg-success
                                                                {% elif cita.estado == 'cancelada' %}bg-danger
                                                                {% endif %}">
                                                                {{ cita.get_estado_display }}
                                                            </span>
                                                        </div>
                                                        <div class="col-md-6">
                                                            <h6 class="text-muted mb-1">Consultorio</h6>
                                                            <p class="mb-0">{{ cita.medico.consultorio }}</p>
                                                        </div>
                                                    </div>
                                                    {% if cita.motivo %}
                                                    <div class="mb-3">
                                                        <h6 class="text-muted mb-1">Motivo de la Cita</h6>
                                                        <p class="mb-0">{{ cita.motivo }}</p>
                                                    </div>
                                                    {% endif %}
                                                    {% if cita.observaciones %}
                                                    <div>
                                                        <h6 class="text-muted mb-1">Observaciones</h6>
                                                        <p class="mb-0">{{ cita.observaciones }}</p>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <h6 class="text-muted mb-2">Información del Médico</h6>
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center mb-3">
                                                        <div class="avatar-container me-3" style="width: 60px; height: 60px; background-color: #1e88e5; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                            <span class="text-white" style="font-size: 1.5rem;">{{ cita.medico.usuario.nombres|first }}{{ cita.medico.usuario.apellidos|first }}</span>
                                                        </div>
                                                        <div>
                                                            <h5 class="mb-0">Dr. {{ cita.medico.usuario.nombres }} {{ cita.medico.usuario.apellidos }}</h5>
                                                            <p class="text-muted mb-0">{{ cita.medico.especialidad.nombre }}</p>
                                                        </div>
                                                    </div>
                                                    <div class="mb-3">
                                                        <h6 class="text-muted mb-1">Correo Electrónico</h6>
                                                        <p class="mb-0">{{ cita.medico.usuario.email }}</p>
                                                    </div>
                                                    <div>
                                                        <h6 class="text-muted mb-1">Consultorio</h6>
                                                        <p class="mb-0">{{ cita.medico.consultorio }}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if cita.estado == 'atendida' and cita.historial %}
                                <div class="mt-3">
                                    <h6 class="text-muted mb-2">Resultados de la Consulta</h6>
                                    <div class="card">
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <h6 class="text-muted mb-1">Diagnóstico</h6>
                                                <p class="mb-0">{{ cita.historial.diagnostico }}</p>
                                            </div>
                                            {% if cita.historial.tratamiento %}
                                            <div class="mb-3">
                                                <h6 class="text-muted mb-1">Tratamiento</h6>
                                                <p class="mb-0">{{ cita.historial.tratamiento }}</p>
                                            </div>
                                            {% endif %}
                                            {% if cita.historial.observaciones %}
                                            <div>
                                                <h6 class="text-muted mb-1">Observaciones Médicas</h6>
                                                <p class="mb-0">{{ cita.historial.observaciones }}</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="modal-footer">
                                {% if cita.estado == 'pendiente' or cita.estado == 'confirmada' %}
                                <button type="button" class="btn btn-danger" onclick="cancelarCita('{{ cita.id }}')">
                                    <i class="fas fa-times-circle me-1"></i> Cancelar Cita
                                </button>
                                {% endif %}
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No tienes citas registradas que coincidan con los filtros seleccionados.
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Estilo para hacer las tarjetas de citas clickeables
    document.addEventListener('DOMContentLoaded', function() {
        const citaCards = document.querySelectorAll('.cita-card');
        
        citaCards.forEach(card => {
            card.style.cursor = 'pointer';
            const hoverDetails = card.querySelector('.hover-details');
            
            card.addEventListener('mouseenter', function() {
                this.classList.add('shadow');
                this.style.transform = 'translateY(-5px)';
                this.style.transition = 'all 0.3s ease';
                if (hoverDetails) {
                    hoverDetails.style.opacity = '1';
                    hoverDetails.style.transition = 'opacity 0.3s ease';
                }
            });
            
            card.addEventListener('mouseleave', function() {
                this.classList.remove('shadow');
                this.style.transform = 'translateY(0)';
                if (hoverDetails) {
                    hoverDetails.style.opacity = '0';
                }
            });
        });
    });
    
    // Función para cancelar cita
    function cancelarCita(citaId) {
        if (confirm('¿Estás seguro de que deseas cancelar esta cita? Esta acción no se puede deshacer.')) {
            window.location.href = '/citas/cancelar/' + citaId + '/';
        }
    }
</script>
{% endblock %}
