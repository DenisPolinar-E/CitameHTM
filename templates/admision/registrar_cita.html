{% extends 'dashboard/base_dashboard.html' %}
{% load static %}

{% block title %}Registrar Cita - Hospital Tingo María{% endblock %}

{% block page_title %}Registrar Cita{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .form-section-title {
        color: #1976d2;
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
    }
    
    .form-section-title i {
        margin-right: 10px;
        font-size: 1.4rem;
    }
    
    .search-results {
        position: absolute;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 0 0 5px 5px;
        z-index: 1000;
        display: none;
    }
    
    .search-result-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .search-result-item:hover {
        background-color: #f5f5f5;
    }
    
    .search-result-item:last-child {
        border-bottom: none;
    }
    
    .patient-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border-left: 4px solid #1976d2;
    }
    
    .patient-card h5 {
        color: #1976d2;
        margin-bottom: 10px;
    }
    
    .patient-card p {
        margin-bottom: 5px;
        color: #555;
    }
    
    .patient-card .patient-info {
        display: flex;
        flex-wrap: wrap;
    }
    
    .patient-card .patient-info div {
        margin-right: 20px;
        margin-bottom: 5px;
    }
    
    .patient-card .patient-info span {
        font-weight: 600;
        color: #333;
    }
    
    .time-slot {
        padding: 8px 12px;
        margin: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        display: inline-block;
        transition: all 0.2s;
        background-color: #f8f9fa;
        font-size: 0.9rem;
        text-align: center;
        width: calc(33.33% - 10px);
        box-sizing: border-box;
    }
    
    .time-slot:hover {
        background-color: #f0f7ff;
        border-color: #90caf9;
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .time-slot.selected {
        background-color: #1e88e5;
        color: white;
        border-color: #1565c0;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(30,136,229,0.4);
    }
    
    .time-slot.disabled {
        background-color: #f5f5f5;
        color: #999;
        cursor: not-allowed;
    }
    
    #horariosDisponibles {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        justify-content: flex-start;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block sidebar_menu %}
<a href="{% url 'dashboard_admision' %}" class="menu-item"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
<a href="{% url 'registrar_cita' %}" class="menu-item active"><i class="fas fa-calendar-plus"></i> Registrar Cita</a>
<!-- Comentado temporalmente hasta que se implemente la vista
<a href="#" class="menu-item"><i class="fas fa-search"></i> Buscar Paciente</a>
-->
<a href="#" class="menu-item"><i class="fas fa-clock"></i> Disponibilidad Médica</a>
<a href="#" class="menu-item"><i class="fas fa-exclamation-triangle"></i> Justificar Inasistencia</a>
<a href="#" class="menu-item"><i class="fas fa-user"></i> Mi Perfil</a>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Mensajes de alerta -->
    {% if messages %}
    <div class="row mb-4">
        <div class="col-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <form method="post" id="formRegistrarCita">
        {% csrf_token %}
        
        <!-- Sección 1: Búsqueda y selección de paciente -->
        <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-user-injured"></i> Datos del Paciente</h3>
            
            <div class="row mb-4">
                <div class="col-md-6 position-relative">
                    <label for="buscarPaciente" class="form-label">Buscar Paciente (por nombre, apellido o DNI)</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="buscarPaciente" name="q" placeholder="Ingrese al menos 3 caracteres" value="{{ query }}" autocomplete="off">
                        <button type="button" class="btn btn-primary" id="btnBuscarPaciente">Buscar</button>
                    </div>
                    <div id="searchResults" class="search-results"></div>
                </div>
                
                <div class="col-md-6">
                    <input type="hidden" id="pacienteId" name="paciente" value="{% if paciente_seleccionado %}{{ paciente_seleccionado.id }}{% endif %}">
                    
                    {% if paciente_seleccionado %}
                    <div class="patient-card" id="patientCard">
                        <h5><i class="fas fa-user-check me-2"></i>Paciente Seleccionado</h5>
                        <div class="patient-info">
                            <div>
                                <p>Nombre: <span>{{ paciente_seleccionado.usuario.nombres }} {{ paciente_seleccionado.usuario.apellidos }}</span></p>
                                <p>DNI: <span>{{ paciente_seleccionado.usuario.dni }}</span></p>
                            </div>
                            <div>
                                <p>Fecha de Nacimiento: <span>{{ paciente_seleccionado.usuario.fecha_nacimiento|date:"d/m/Y" }}</span></p>
                                <p>Género: <span>{{ paciente_seleccionado.usuario.get_genero_display }}</span></p>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="alert alert-info mt-4" id="noPatientSelected">
                        <i class="fas fa-info-circle me-2"></i> Busque y seleccione un paciente para continuar.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Sección 2: Datos de la cita -->
        <div class="form-section">
            <h3 class="form-section-title"><i class="fas fa-calendar-alt"></i> Datos de la Cita</h3>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="especialidad" class="form-label">Especialidad</label>
                    <select class="form-select" id="especialidad" name="especialidad" {% if not paciente_seleccionado %}disabled{% endif %}>
                        <option value="">Seleccione una especialidad</option>
                        {% for especialidad in especialidades %}
                        <option value="{{ especialidad.id }}" {% if especialidad_seleccionada and especialidad.id == especialidad_seleccionada.id %}selected{% endif %}>
                            {{ especialidad.nombre }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-6">
                    <label for="medico" class="form-label">Médico</label>
                    <select class="form-select" id="medico" name="medico" {% if not especialidad_seleccionada %}disabled{% endif %}>
                        <option value="">Seleccione un médico</option>
                        {% for medico in medicos %}
                        <option value="{{ medico.id }}" {% if medico_seleccionado and medico.id == medico_seleccionado.id %}selected{% endif %}>
                            Dr(a). {{ medico.usuario.nombres }} {{ medico.usuario.apellidos }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="fecha" class="form-label">Fecha</label>
                    <input type="date" class="form-control" id="fecha" name="fecha" min="{{ today|date:'Y-m-d' }}" value="{{ fecha_seleccionada }}" {% if not medico_seleccionado %}disabled{% endif %}>
                </div>
                
                <div class="col-md-6">
                    <label for="hora" class="form-label">Hora</label>
                    <input type="hidden" id="hora" name="hora" value="">
                    <div id="horariosDisponibles" class="mt-2">
                        {% if horarios_disponibles %}
                            {% for horario in horarios_disponibles %}
                            <div class="time-slot" data-time="{{ horario }}">{{ horario }}</div>
                            {% endfor %}
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i> Seleccione una fecha para ver los horarios disponibles.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-12">
                    <label for="motivo" class="form-label">Motivo de la Consulta</label>
                    <textarea class="form-control" id="motivo" name="motivo" rows="3" placeholder="Describa brevemente el motivo de la consulta" {% if not paciente_seleccionado %}disabled{% endif %}>{{ motivo }}</textarea>
                </div>
            </div>
        </div>
        
        <!-- Botones de acción -->
        <div class="row mb-4">
            <div class="col-12 text-end">
                <button type="button" class="btn btn-secondary me-2" onclick="window.location.href='{% url 'dashboard_admision' %}'">Cancelar</button>
                <button type="submit" class="btn btn-primary" id="btnRegistrarCita" {% if not paciente_seleccionado %}disabled{% endif %}>
                    <i class="fas fa-calendar-check me-2"></i>Registrar Cita
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const buscarPacienteInput = document.getElementById('buscarPaciente');
        const btnBuscarPaciente = document.getElementById('btnBuscarPaciente');
        const searchResults = document.getElementById('searchResults');
        const pacienteIdInput = document.getElementById('pacienteId');
        const patientCard = document.getElementById('patientCard');
        const noPatientSelected = document.getElementById('noPatientSelected');
        
        const especialidadSelect = document.getElementById('especialidad');
        const medicoSelect = document.getElementById('medico');
        const fechaInput = document.getElementById('fecha');
        const horaInput = document.getElementById('hora');
        const horariosDisponibles = document.getElementById('horariosDisponibles');
        const motivoTextarea = document.getElementById('motivo');
        const btnRegistrarCita = document.getElementById('btnRegistrarCita');
        
        // Función para buscar pacientes
        function buscarPacientes() {
            const query = buscarPacienteInput.value.trim();
            if (query.length < 3) {
                searchResults.innerHTML = '<div class="p-3 text-muted">Ingrese al menos 3 caracteres para buscar</div>';
                searchResults.style.display = 'block';
                return;
            }
            
            fetch(`/api/pacientes/buscar/?q=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.results.length === 0) {
                        searchResults.innerHTML = '<div class="p-3 text-muted">No se encontraron pacientes con ese criterio</div>';
                    } else {
                        let html = '';
                        data.results.forEach(paciente => {
                            html += `
                                <div class="search-result-item" data-id="${paciente.id}" data-nombre="${paciente.nombre}" data-dni="${paciente.dni}" data-fecha="${paciente.fecha_nacimiento}">
                                    <strong>${paciente.nombre}</strong><br>
                                    <small>DNI: ${paciente.dni} - Fecha Nac.: ${paciente.fecha_nacimiento}</small>
                                </div>
                            `;
                        });
                        searchResults.innerHTML = html;
                        
                        // Agregar eventos a los resultados
                        document.querySelectorAll('.search-result-item').forEach(item => {
                            item.addEventListener('click', function() {
                                const id = this.getAttribute('data-id');
                                const nombre = this.getAttribute('data-nombre');
                                const dni = this.getAttribute('data-dni');
                                const fecha = this.getAttribute('data-fecha');
                                
                                // Actualizar campo oculto y mostrar tarjeta de paciente
                                pacienteIdInput.value = id;
                                
                                // Crear tarjeta de paciente si no existe
                                if (!patientCard) {
                                    const newPatientCard = document.createElement('div');
                                    newPatientCard.className = 'patient-card';
                                    newPatientCard.id = 'patientCard';
                                    newPatientCard.innerHTML = `
                                        <h5><i class="fas fa-user-check me-2"></i>Paciente Seleccionado</h5>
                                        <div class="patient-info">
                                            <div>
                                                <p>Nombre: <span>${nombre}</span></p>
                                                <p>DNI: <span>${dni}</span></p>
                                            </div>
                                            <div>
                                                <p>Fecha de Nacimiento: <span>${fecha}</span></p>
                                            </div>
                                        </div>
                                    `;
                                    
                                    if (noPatientSelected) {
                                        noPatientSelected.replaceWith(newPatientCard);
                                    } else {
                                        pacienteIdInput.parentNode.appendChild(newPatientCard);
                                    }
                                }
                                
                                // Habilitar campos del formulario
                                especialidadSelect.disabled = false;
                                motivoTextarea.disabled = false;
                                btnRegistrarCita.disabled = false;
                                
                                // Ocultar resultados
                                searchResults.style.display = 'none';
                            });
                        });
                    }
                    searchResults.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error al buscar pacientes:', error);
                    searchResults.innerHTML = '<div class="p-3 text-danger">Error al buscar pacientes</div>';
                    searchResults.style.display = 'block';
                });
        }
        
        // Evento para buscar pacientes
        btnBuscarPaciente.addEventListener('click', buscarPacientes);
        buscarPacienteInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                buscarPacientes();
            } else if (this.value.trim().length >= 3) {
                buscarPacientes();
            } else {
                searchResults.style.display = 'none';
            }
        });
        
        // Ocultar resultados al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!buscarPacienteInput.contains(e.target) && !searchResults.contains(e.target) && !btnBuscarPaciente.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });
        
        // Evento para cargar médicos al seleccionar especialidad
        especialidadSelect.addEventListener('change', function() {
            medicoSelect.innerHTML = '<option value="">Seleccione un médico</option>';
            medicoSelect.disabled = true;
            fechaInput.disabled = true;
            horariosDisponibles.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i> Seleccione un médico y una fecha para ver los horarios disponibles.</div>';
            
            if (this.value) {
                fetch(`/api/derivacion/medicos-por-especialidad/${this.value}/`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(medico => {
                            const option = document.createElement('option');
                            option.value = medico.id;
                            option.textContent = `Dr(a). ${medico.nombres} ${medico.apellidos}`;
                            medicoSelect.appendChild(option);
                        });
                        medicoSelect.disabled = false;
                    })
                    .catch(error => console.error('Error al cargar médicos:', error));
            }
        });
        
        // Evento para habilitar fecha al seleccionar médico
        medicoSelect.addEventListener('change', function() {
            fechaInput.disabled = !this.value;
            horariosDisponibles.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i> Seleccione una fecha para ver los horarios disponibles.</div>';
            fechaInput.value = '';
            horaInput.value = '';
        });
        
        // Evento para cargar horarios disponibles al seleccionar fecha
        fechaInput.addEventListener('change', function() {
            if (this.value && medicoSelect.value) {
                horariosDisponibles.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i> Cargando horarios disponibles...</div>';
                
                fetch(`/api/derivacion/horarios-disponibles/${medicoSelect.value}/${this.value}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.length === 0) {
                            horariosDisponibles.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i> No hay horarios disponibles para la fecha seleccionada.</div>';
                        } else {
                            let html = '';
                            data.forEach(horario => {
                                // Convertir las horas de inicio y fin a objetos Date para manipularlos
                                const [horaInicioHora, horaInicioMinuto] = horario.hora_inicio.split(':').map(Number);
                                const [horaFinHora, horaFinMinuto] = horario.hora_fin.split(':').map(Number);
                                
                                // Crear objetos Date para facilitar la manipulación (usamos una fecha arbitraria)
                                const fechaBase = new Date(2023, 0, 1);
                                const horaInicio = new Date(fechaBase);
                                horaInicio.setHours(horaInicioHora, horaInicioMinuto, 0);
                                
                                const horaFin = new Date(fechaBase);
                                horaFin.setHours(horaFinHora, horaFinMinuto, 0);
                                
                                // Generar intervalos de 30 minutos
                                const intervalos = [];
                                let horaActual = new Date(horaInicio);
                                
                                while (horaActual < horaFin) {
                                    const horaActualStr = `${String(horaActual.getHours()).padStart(2, '0')}:${String(horaActual.getMinutes()).padStart(2, '0')}`;
                                    
                                    // Calcular la hora de fin del intervalo (30 minutos después)
                                    const horaIntervaloFin = new Date(horaActual);
                                    horaIntervaloFin.setMinutes(horaIntervaloFin.getMinutes() + 30);
                                    
                                    // Si la hora de fin del intervalo excede la hora de fin del médico, usar la hora de fin del médico
                                    if (horaIntervaloFin > horaFin) {
                                        break;
                                    }
                                    
                                    const horaIntervaloFinStr = `${String(horaIntervaloFin.getHours()).padStart(2, '0')}:${String(horaIntervaloFin.getMinutes()).padStart(2, '0')}`;
                                    
                                    intervalos.push({
                                        inicio: horaActualStr,
                                        fin: horaIntervaloFinStr,
                                        texto: `${horaActualStr} - ${horaIntervaloFinStr}`
                                    });
                                    
                                    // Avanzar 30 minutos
                                    horaActual.setMinutes(horaActual.getMinutes() + 30);
                                }
                                
                                // Crear HTML para cada intervalo
                                intervalos.forEach(intervalo => {
                                    html += `<div class="time-slot" data-time="${intervalo.inicio}" data-fin="${intervalo.fin}" data-id="${horario.id}">${intervalo.texto}</div>`;
                                });
                            });
                            
                            horariosDisponibles.innerHTML = html;
                            
                            // Agregar eventos a los horarios
                            document.querySelectorAll('.time-slot').forEach(slot => {
                                slot.addEventListener('click', function() {
                                    document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                                    this.classList.add('selected');
                                    horaInput.value = this.getAttribute('data-time');
                                });
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error al cargar horarios:', error);
                        horariosDisponibles.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i> Error al cargar los horarios disponibles.</div>';
                    });
            }
        });
        
        // Validación del formulario antes de enviar
        document.getElementById('formRegistrarCita').addEventListener('submit', function(e) {
            if (!pacienteIdInput.value) {
                e.preventDefault();
                alert('Debe seleccionar un paciente');
                return false;
            }
            
            if (!especialidadSelect.value) {
                e.preventDefault();
                alert('Debe seleccionar una especialidad');
                return false;
            }
            
            if (!medicoSelect.value) {
                e.preventDefault();
                alert('Debe seleccionar un médico');
                return false;
            }
            
            if (!fechaInput.value) {
                e.preventDefault();
                alert('Debe seleccionar una fecha');
                return false;
            }
            
            if (!horaInput.value) {
                e.preventDefault();
                alert('Debe seleccionar un horario');
                return false;
            }
            
            if (!motivoTextarea.value.trim()) {
                e.preventDefault();
                alert('Debe ingresar el motivo de la consulta');
                return false;
            }
        });
    });
</script>
{% endblock %}
